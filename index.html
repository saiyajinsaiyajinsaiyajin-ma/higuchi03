<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>防災訓練 点呼ボード</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .modal-animate { animation: fadeIn 0.2s ease-out forwards; }
    .animate-pulse-custom { animation: pulse 2s cubic-bezier(0.4,0,0.6,1) infinite; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .5; } }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-20 font-sans">

<header class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-10">
  <div class="max-w-4xl mx-auto">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-xl font-bold">防災訓練 点呼ボード</h1>
      <div class="text-xs bg-blue-700 px-2 py-1 rounded">HTML版</div>
    </div>
    <div class="grid grid-cols-3 gap-2 text-center">
      <div class="bg-blue-500/50 p-2 rounded-lg"><div class="text-xs opacity-80">報告済み</div><div class="text-2xl font-bold"><span id="stat-reported">0</span> / 12</div></div>
      <div class="bg-blue-500/50 p-2 rounded-lg"><div class="text-xs opacity-80">確認人数</div><div class="text-2xl font-bold"><span id="stat-students">0</span> 名</div></div>
      <div id="stat-issue-box" class="bg-blue-500/50 p-2 rounded-lg"><div class="text-xs opacity-80">要対応</div><div class="text-2xl font-bold"><span id="stat-issues">0</span> クラス</div></div>
    </div>
  </div>
</header>

<main class="max-w-4xl mx-auto p-4">
  <div id="loading" class="text-center py-10 text-gray-500">データを読み込んでいます...</div>
  <div id="class-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 hidden"></div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // ★ここをあなたの Firebase 設定に書き換えてください
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const ALL_CLASSES = [];
  [1,2,3,4,5,6].forEach(g => ['A','B'].forEach(c => ALL_CLASSES.push({id:`${g}-${c}`, label:`${g}年${c}組`})));  

  let drillData = {};

  const gridEl = document.getElementById('class-grid');
  const loadingEl = document.getElementById('loading');

  function render() {
    gridEl.innerHTML = '';
    let reported = 0, students = 0, issues = 0;
    ALL_CLASSES.forEach(cls => {
      const d = drillData[cls.id];
      if (d?.reported) { reported++; students += d.count || 0; if (d.status === 'issue') issues++; }
      const btn = document.createElement('button');
      btn.className = `p-4 rounded-xl border ${d?.reported ? (d.status==='issue'?'bg-red-100':'bg-green-100') : 'bg-gray-100'}`;
      btn.innerHTML = `<div class='font-bold text-lg'>${cls.label}</div><div class='text-sm'>${d?.reported ? d.count+'名' : '未報告'}</div>`;
      btn.onclick = async () => {
        const count = prompt(`${cls.label} の確認人数を入力`);
        if (count === null) return;
        await setDoc(doc(db,'drill',cls.id), { count:Number(count), reported:true, status:'safe', updatedAt:serverTimestamp() }, {merge:true});
      };
      gridEl.appendChild(btn);
    });
    document.getElementById('stat-reported').textContent = reported;
    document.getElementById('stat-students').textContent = students;
    document.getElementById('stat-issues').textContent = issues;
  }

  signInAnonymously(auth);
  onAuthStateChanged(auth, user => {
    if (!user) return;
    onSnapshot(collection(db,'drill'), snap => {
      drillData = {};
      snap.forEach(d => drillData[d.id] = d.data());
      loadingEl.classList.add('hidden');
      gridEl.classList.remove('hidden');
      render();
    });
  });
</script>
</body>
</html>
